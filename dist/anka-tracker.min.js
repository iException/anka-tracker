/**
 * @anka-dev/tracker.
 * V0.4.5
 * Fri Dec 28 2018 01:11:39 GMT+0800 (CST)
 * https://github.com/iException/anka-tracker#readme
 * MIT License
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Tracker={})}(this,function(t){"use strict";function e(t,e){function r(){this.constructor=t}l(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function r(t,e,r,n){var o,i=arguments.length,a=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var c=t.length-1;c>=0;c--)(o=t[c])&&(a=(i<3?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a}function n(t){return new Promise(function(e,r){wx.request(h({},t,{success:function(t){t.statusCode>=200&&t.statusCode<300?e&&e(t.data):r&&r(t.data)},fail:function(t){r&&r(t)}}))})}function o(t){return new Promise(function(e,r){wx.setStorage(h({},t,{success:function(t){e(t)},fail:function(t){r(t)}}))})}function i(t){return new Promise(function(e,r){wx.getStorage({key:t,success:function(t){e(t.data)},fail:function(t){r(t)}})})}function a(){return new Promise(function(t,e){wx.getSystemInfo({success:function(e){t(e)},fail:function(t){e(t)}})})}function c(){return new Promise(function(t,e){wx.getNetworkType({success:function(e){t(e.networkType)},fail:function(t){e(t)}})})}function s(t){wx.onNetworkStatusChange(function(e){t(e.networkType)})}function u(t,e,r){var n=t[e];t[e]=function(t){return r.call(this,t),n&&n.call(this,t)}}function p(){return function(t,e,r){return r.writable=!1,r}}var f,l=function(t,e){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},h=function(){return(h=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++){e=arguments[r];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t}).apply(this,arguments)},d=function(){function t(t){this.data=[],this.config=t}return t.prototype.get=function(){return i("tracker_tasks").then(function(t){return Promise.resolve(t)}).catch(function(t){return Promise.resolve([])})},t.prototype.update=function(t){return this.data=t,o({key:"tracker_tasks",data:t})},t}(),y={DEBUG:!0,log:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=new Date,n=this.format(r.getHours())+":"+this.format(r.getMinutes())+":"+this.format(r.getSeconds());this.DEBUG&&console.log.apply(console,["%c[🔍 tracker] "+n,"color:rgba(118,147,92,1);"].concat(t))},format:function(t,e){return void 0===t&&(t=""),void 0===e&&(e=2),("00"+t).slice(0-e)}},g=Object.prototype.hasOwnProperty,m=function(){for(var t=[],e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t}(),v=function(t){for(;t.length>1;){var e=t.pop(),r=e.obj[e.prop];if(Array.isArray(r)){for(var n=[],o=0;o<r.length;++o)void 0!==r[o]&&n.push(r[o]);e.obj[e.prop]=n}}},w=function(t,e){for(var r=e&&e.plainObjects?Object.create(null):{},n=0;n<t.length;++n)void 0!==t[n]&&(r[n]=t[n]);return r},b={arrayToObject:w,assign:function(t,e){return Object.keys(e).reduce(function(t,r){return t[r]=e[r],t},t)},combine:function(t,e){return[].concat(t,e)},compact:function(t){for(var e=[{obj:{o:t},prop:"o"}],r=[],n=0;n<e.length;++n)for(var o=e[n],i=o.obj[o.prop],a=Object.keys(i),c=0;c<a.length;++c){var s=a[c],u=i[s];"object"==typeof u&&null!==u&&-1===r.indexOf(u)&&(e.push({obj:i,prop:s}),r.push(u))}return v(e),t},decode:function(t,e,r){var n=t.replace(/\+/g," ");if("iso-8859-1"===r)return n.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(n)}catch(t){return n}},encode:function(t,e,r){if(0===t.length)return t;var n="string"==typeof t?t:String(t);if("iso-8859-1"===r)return escape(n).replace(/%u[0-9a-f]{4}/gi,function(t){return"%26%23"+parseInt(t.slice(2),16)+"%3B"});for(var o="",i=0;i<n.length;++i){var a=n.charCodeAt(i);45===a||46===a||95===a||126===a||a>=48&&a<=57||a>=65&&a<=90||a>=97&&a<=122?o+=n.charAt(i):a<128?o+=m[a]:a<2048?o+=m[192|a>>6]+m[128|63&a]:a<55296||a>=57344?o+=m[224|a>>12]+m[128|a>>6&63]+m[128|63&a]:(i+=1,a=65536+((1023&a)<<10|1023&n.charCodeAt(i)),o+=m[240|a>>18]+m[128|a>>12&63]+m[128|a>>6&63]+m[128|63&a])}return o},isBuffer:function(t){return null!==t&&void 0!==t&&!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))},isRegExp:function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},merge:function t(e,r,n){if(!r)return e;if("object"!=typeof r){if(Array.isArray(e))e.push(r);else{if("object"!=typeof e)return[e,r];(n&&(n.plainObjects||n.allowPrototypes)||!g.call(Object.prototype,r))&&(e[r]=!0)}return e}if("object"!=typeof e)return[e].concat(r);var o=e;return Array.isArray(e)&&!Array.isArray(r)&&(o=w(e,n)),Array.isArray(e)&&Array.isArray(r)?(r.forEach(function(r,o){g.call(e,o)?e[o]&&"object"==typeof e[o]?e[o]=t(e[o],r,n):e.push(r):e[o]=r}),e):Object.keys(r).reduce(function(e,o){var i=r[o];return g.call(e,o)?e[o]=t(e[o],i,n):e[o]=i,e},o)}},k=String.prototype.replace,O={default:"RFC3986",formatters:{RFC1738:function(t){return k.call(t,/%20/g,"+")},RFC3986:function(t){return t}},RFC1738:"RFC1738",RFC3986:"RFC3986"},S={brackets:function(t){return t+"[]"},indices:function(t,e){return t+"["+e+"]"},repeat:function(t){return t}},j=Array.isArray,_=Array.prototype.push,P=function(t,e){_.apply(t,j(e)?e:[e])},D=Date.prototype.toISOString,C={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:b.encode,encodeValuesOnly:!1,indices:!1,serializeDate:function(t){return D.call(t)},skipNulls:!1,strictNullHandling:!1},A=function t(e,r,n,o,i,a,c,s,u,p,f,l,h){var d=e;if("function"==typeof c?d=c(r,d):d instanceof Date&&(d=p(d)),null===d){if(o)return a&&!l?a(r,C.encoder,h):r;d=""}if("string"==typeof d||"number"==typeof d||"boolean"==typeof d||b.isBuffer(d))return a?[f(l?r:a(r,C.encoder,h))+"="+f(a(d,C.encoder,h))]:[f(r)+"="+f(String(d))];var y=[];if(void 0===d)return y;var g;if(Array.isArray(c))g=c;else{var m=Object.keys(d);g=s?m.sort(s):m}for(var v=0;v<g.length;++v){var w=g[v];i&&null===d[w]||(Array.isArray(d)?P(y,t(d[w],n(r,w),n,o,i,a,c,s,u,p,f,l,h)):P(y,t(d[w],r+(u?"."+w:"["+w+"]"),n,o,i,a,c,s,u,p,f,l,h)))}return y},E=function(t,e){var r=t,n=e?b.assign({},e):{};if(null!==n.encoder&&void 0!==n.encoder&&"function"!=typeof n.encoder)throw new TypeError("Encoder has to be a function.");var o=void 0===n.delimiter?C.delimiter:n.delimiter,i="boolean"==typeof n.strictNullHandling?n.strictNullHandling:C.strictNullHandling,a="boolean"==typeof n.skipNulls?n.skipNulls:C.skipNulls,c="boolean"==typeof n.encode?n.encode:C.encode,s="function"==typeof n.encoder?n.encoder:C.encoder,u="function"==typeof n.sort?n.sort:null,p=void 0===n.allowDots?C.allowDots:!!n.allowDots,f="function"==typeof n.serializeDate?n.serializeDate:C.serializeDate,l="boolean"==typeof n.encodeValuesOnly?n.encodeValuesOnly:C.encodeValuesOnly,h=n.charset||C.charset;if(void 0!==n.charset&&"utf-8"!==n.charset&&"iso-8859-1"!==n.charset)throw new Error("The charset option must be either utf-8, iso-8859-1, or undefined");if(void 0===n.format)n.format=O.default;else if(!Object.prototype.hasOwnProperty.call(O.formatters,n.format))throw new TypeError("Unknown format option provided.");var d,y,g=O.formatters[n.format];"function"==typeof n.filter?r=(y=n.filter)("",r):Array.isArray(n.filter)&&(d=y=n.filter);var m=[];if("object"!=typeof r||null===r)return"";var v;v=n.arrayFormat in S?n.arrayFormat:"indices"in n?n.indices?"indices":"repeat":"indices";var w=S[v];d||(d=Object.keys(r)),u&&d.sort(u);for(var k=0;k<d.length;++k){var j=d[k];a&&null===r[j]||P(m,A(r[j],j,w,i,a,c?s:null,y,u,p,f,g,l,h))}var _=m.join(o),D=!0===n.addQueryPrefix?"?":"";return n.charsetSentinel&&(D+="iso-8859-1"===h?"utf8=%26%2310003%3B&":"utf8=%E2%9C%93&"),_.length>0?D+_:""},L=Object.prototype.hasOwnProperty,N={allowDots:!1,allowPrototypes:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,decoder:b.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},x=function(t){return t.replace(/&#(\d+);/g,function(t,e){return String.fromCharCode(parseInt(e,10))})},I=function(t,e){var r,n={},o=e.ignoreQueryPrefix?t.replace(/^\?/,""):t,i=e.parameterLimit===1/0?void 0:e.parameterLimit,a=o.split(e.delimiter,i),c=-1,s=e.charset;if(e.charsetSentinel)for(r=0;r<a.length;++r)0===a[r].indexOf("utf8=")&&("utf8=%E2%9C%93"===a[r]?s="utf-8":"utf8=%26%2310003%3B"===a[r]&&(s="iso-8859-1"),c=r,r=a.length);for(r=0;r<a.length;++r)if(r!==c){var u,p,f=a[r],l=f.indexOf("]="),h=-1===l?f.indexOf("="):l+1;-1===h?(u=e.decoder(f,N.decoder,s),p=e.strictNullHandling?null:""):(u=e.decoder(f.slice(0,h),N.decoder,s),p=e.decoder(f.slice(h+1),N.decoder,s)),p&&e.interpretNumericEntities&&"iso-8859-1"===s&&(p=x(p)),L.call(n,u)?n[u]=b.combine(n[u],p):n[u]=p}return n},T=function(t,e,r){for(var n=e,o=t.length-1;o>=0;--o){var i,a=t[o];if("[]"===a&&r.parseArrays)i=[].concat(n);else{i=r.plainObjects?Object.create(null):{};var c="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,s=parseInt(c,10);r.parseArrays||""!==c?!isNaN(s)&&a!==c&&String(s)===c&&s>=0&&r.parseArrays&&s<=r.arrayLimit?(i=[])[s]=n:i[c]=n:i={0:n}}n=i}return n},U=function(t,e,r){if(t){var n=r.allowDots?t.replace(/\.([^.[]+)/g,"[$1]"):t,o=/(\[[^[\]]*])/g,i=/(\[[^[\]]*])/.exec(n),a=i?n.slice(0,i.index):n,c=[];if(a){if(!r.plainObjects&&L.call(Object.prototype,a)&&!r.allowPrototypes)return;c.push(a)}for(var s=0;null!==(i=o.exec(n))&&s<r.depth;){if(s+=1,!r.plainObjects&&L.call(Object.prototype,i[1].slice(1,-1))&&!r.allowPrototypes)return;c.push(i[1])}return i&&c.push("["+n.slice(i.index)+"]"),T(c,e,r)}},q={formats:O,parse:function(t,e){var r=e?b.assign({},e):{};if(null!==r.decoder&&void 0!==r.decoder&&"function"!=typeof r.decoder)throw new TypeError("Decoder has to be a function.");if(r.ignoreQueryPrefix=!0===r.ignoreQueryPrefix,r.delimiter="string"==typeof r.delimiter||b.isRegExp(r.delimiter)?r.delimiter:N.delimiter,r.depth="number"==typeof r.depth?r.depth:N.depth,r.arrayLimit="number"==typeof r.arrayLimit?r.arrayLimit:N.arrayLimit,r.parseArrays=!1!==r.parseArrays,r.decoder="function"==typeof r.decoder?r.decoder:N.decoder,r.allowDots=void 0===r.allowDots?N.allowDots:!!r.allowDots,r.plainObjects="boolean"==typeof r.plainObjects?r.plainObjects:N.plainObjects,r.allowPrototypes="boolean"==typeof r.allowPrototypes?r.allowPrototypes:N.allowPrototypes,r.parameterLimit="number"==typeof r.parameterLimit?r.parameterLimit:N.parameterLimit,r.strictNullHandling="boolean"==typeof r.strictNullHandling?r.strictNullHandling:N.strictNullHandling,void 0!==r.charset&&"utf-8"!==r.charset&&"iso-8859-1"!==r.charset)throw new Error("The charset option must be either utf-8, iso-8859-1, or undefined");if(void 0===r.charset&&(r.charset=N.charset),""===t||null===t||void 0===t)return r.plainObjects?Object.create(null):{};for(var n="string"==typeof t?I(t,r):t,o=r.plainObjects?Object.create(null):{},i=Object.keys(n),a=0;a<i.length;++a){var c=i[a],s=U(c,n[c],r);o=b.merge(o,s,r)}return b.compact(o)},stringify:E},M=q.stringify,R=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.getCommonData=function(t){var e=this,r=t.onLaunchOption,n=void 0===r?{}:r;return Promise.all([this.getTrackId(),a(),c()]).then(function(t){var r=t[0],o=t[1],i=t[2],a=o.system.split(/\s+/),c=q.stringify(n.query),s={__debug:1,sdk_version:"0.4.5",model:o.model,os:a[0],os_version:a[1],network_type:i,env_version:o.version,ip:"",app_type:"wx",app_id:"",app_name:"",template_version:"",app_category:"",source:n.scene,source_path:n.path||"",source_app_id:n.referrerInfo?n.referrerInfo.appId||"":"",source_params:c,source_src_key:n.query?n.query[e.config.sourceSrcKey]||"":"",track_id:r};return Promise.resolve(s)})},r.prototype.getTrackId=function(){var t=this;return i(this.config.trackIdKey).then(function(t){return Promise.resolve(t)}).catch(function(e){return t.setTrackId()})},r.prototype.setTrackId=function(){var t=this,e=this.genUUId();return o({key:this.config.trackIdKey,data:e}).then(function(){return Promise.resolve(e)},function(){return o({key:t.config.trackIdKey,data:e}),Promise.resolve(e)})},r.prototype.genUUId=function(){return Date.now()+"-"+Math.floor(1e7*Math.random())+"-"+Math.random().toString(16).replace(".","")+"-"+String(31242*Math.random()).replace(".","").slice(0,8)},r}(function(){function t(t){this.config=t}return t.validate=function(t,e){var r={required:[],optional:[]};for(var n in e)e.hasOwnProperty(n)&&!t[n]&&r[1===e[n]?"required":"optional"].push(n);return r},t}()),F=function(){function t(t,e){this.url=t.trackerHost,this.config=t,this.commonData=e}return t.prototype.send=function(t){var e=this.url,r=h({},this.commonData,t.data);if(this.config.attachActionToUrl){var o=r.action||"";e=/\/$/.test(this.url)?""+this.url+o:this.url+"/"+o}return"function"==typeof this.config.beforeSend&&(r=this.config.beforeSend(r)),y.log("打点数据校验结果:",t,R.validate(r,this.config.dataScheme)),n({url:e,method:this.config.httpMethod,data:r}).then(function(){return t.isSucceed(),Promise.resolve(t)}).catch(function(){return t.isFailed(),Promise.resolve(t)})},t}(),H=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.getNetworkStatus=function(){return c().then(function(t){return Promise.resolve(t)},function(t){return console.error("[tracker] 获取网络状态失败",t),Promise.resolve("none")})},r.prototype.watchNetworkStatusChange=function(t){s(t)},r}(function(){function t(t){this.config=t}return t}());!function(t){t[t.SUCCESS=-1]="SUCCESS",t[t.PENDING=0]="PENDING",t[t.FAILED=1]="FAILED"}(f||(f={}));var Q,B=function(){function t(t){var e=Date.now();this._id=Math.random().toString(16).replace(".",""),this.status=f.PENDING,this.data=t,this.timestamp=e}return t.prototype.isSucceed=function(){this.status=f.SUCCESS},t.prototype.isFailed=function(){this.status++},t}();!function(t){t[t.IDLE=0]="IDLE",t[t.PAUSE=1]="PAUSE",t[t.RUNNING=2]="RUNNING"}(Q||(Q={}));var K=function(){function t(t){this.queue=[],this.failedQueue=[],this.config=t,this.lastStoreUpdate=0,this.executor=new G}return t.prototype.init=function(t){var e=this;this.sender||(this.store=t.store,this.sender=t.sender,this.executor.init(this.sender,this),this.store.get().then(function(t){var r;(r=e.queue).push.apply(r,t.map(function(t){return new B(t.data)})),e.run()}))},t.prototype.push=function(t){t.status===f.PENDING&&this.queue.length<this.config.queueMaxLength?(this.queue.push(t),this.updateStore(),this.run()):t.status>=f.FAILED&&t.status<=this.config.retry&&(this.failedQueue.push(t),this.updateStore(),this.run())},t.prototype.intrude=function(t){this.sender.send(t)},t.prototype.pop=function(){var t=this.failedQueue.length,e=this.config.groupMaxLength,r=t-e>=0?this.failedQueue.splice(0,e):this.failedQueue.splice(0,t).concat(this.queue.splice(0,e-t));return this.updateStore(),r},t.prototype.updateStore=function(t){var e=Date.now();(this.store&&e-this.lastStoreUpdate>=500||t&&this.store)&&(this.store.update(this.queue.concat(this.failedQueue)),this.lastStoreUpdate=e)},t.prototype.run=function(){setTimeout(this.executor.run.bind(this.executor),0)},t.prototype.suspend=function(t){this.updateStore(!0),this.executor.suspend(t)},t}(),G=function(){function t(){this.status=Q.IDLE}return Object.defineProperty(t.prototype,"isIdle",{get:function(){return this.sender&&this.queueManager&&this.status===Q.IDLE},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.sender=t,this.queueManager=e},t.prototype.run=function(){this.isIdle&&this.exec()},t.prototype.exec=function(){var t=this,e=this.queueManager.pop();if(!e.length)return void(this.status=Q.IDLE);this.status=Q.RUNNING,Promise.all(e.map(function(e){return t.sender.send(e)})).then(function(e){e.forEach(function(e){e.status!==f.SUCCESS&&t.queueManager.push(e)})}).then(function(){t.timer=setTimeout(function(){t.exec()},t.queueManager.config.interval)})},t.prototype.suspend=function(t){t?(this.status=Q.PAUSE,clearTimeout(this.timer)):this.status===Q.PAUSE?(this.status=Q.IDLE,this.run()):this.status===Q.IDLE&&this.run()},t}(),V=function(){function t(t){this.config=t,this.queueManager=new K(this.config)}return t.prototype.init=function(t){this.queueManager.init(h({},t))},t.prototype.log=function(t){this.queueManager.push(t)},t.prototype.forceLog=function(t){this.queueManager.intrude(t)},t}(),z={debug:!0,httpMethod:"POST",retry:2,interval:1e3,groupMaxLength:5,timestampKey:"timestamp_ms",trackIdKey:"__track_id",queueMaxLength:500,commonData:{},dataScheme:{},sourceSrcKey:"src",detectChanel:!0,detectAppStart:!0,attachActionToUrl:!1},W=function(){function t(t){void 0===t&&(t={}),Object.assign(this,z,t)}return t}(),$=function(){function t(t){void 0===t&&(t={}),this.config=new W(t),this.core=new V(this.config),y.DEBUG=this.config.debug,this.core.queueManager.suspend(!0),this.networkDetector=new H(this.config),this.commonDataVendor=new R(this.config)}return t.prototype.init=function(t){if(!this.sender){var e=this.handleNetworkStatusChange.bind(this);this.sender=new F(this.config,t),this.store=new d(this.config),this.core.init({sender:this.sender,store:this.store}),this.networkDetector.getNetworkStatus().then(e,e),this.networkDetector.watchNetworkStatusChange(e),y.log("初始化完成")}},t.prototype.handleNetworkStatusChange=function(t){var e="none"===t||t instanceof Error;this.core.queueManager.suspend(e)},t.prototype.log=function(t){this.injectTimestamp(t),this.core.log(new B(t))},t.prototype.forceLog=function(t){this.injectTimestamp(t),this.core.forceLog(new B(t))},t.prototype.injectTimestamp=function(t){if(void 0===t[this.config.timestampKey]){var e=Date.now();t[this.config.timestampKey]=e}return t},r([p()],t.prototype,"init",null),r([p()],t.prototype,"handleNetworkStatusChange",null),r([p()],t.prototype,"log",null),r([p()],t.prototype,"forceLog",null),r([p()],t.prototype,"injectTimestamp",null),t}(),J=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return e(n,t),n.generateTrackerInstance=function(t){var e={};try{var r=require("./anka-tracker.config.js");Object.assign(e,r)}catch(e){!t&&console.log("缺少配置文件 anka-tracker.config.js",e)}t&&Object.assign(e,t);var o=new n(e);if("undefined"!=typeof App&&"undefined"!=typeof Page){var i=App,a=Page;App=function(t){return u(t,"onLaunch",function(t){o.onLaunchOption=t,o.config.detectChanel&&o.detectChanel(t.query[o.config.sourceSrcKey])}),o.config.detectAppStart&&u(t,"onShow",function(t){o.evt("app_start",{})}),i(t)},Page=function(t){return u(t,"onLoad",function(t){this.__page_params__=t}),"function"==typeof o.config.autoPageView&&u(t,"onShow",function(){var t=getCurrentPages().slice().pop();o.config.autoPageView(t,function(e){o.pv(e.action,e,{page_id:t.route,page_url:t.route,page_params:M(t.__page_params__)})})}),a(t)}}else"undefined"!=typeof wx&&wx.getLaunchOptionsSync?(o.onLaunchOption=wx.getLaunchOptionsSync(),o.config.detectChanel&&o.detectChanel(o.onLaunchOption.query[o.config.sourceSrcKey]),console.log("当前处于小游戏环境！")):console.log("anka-tracker无法在当前环境运行！");return o},n.prototype.asyncInitWithCommonData=function(t){var e=this;return void 0===t&&(t={}),this.commonDataVendor.getCommonData({onLaunchOption:this.onLaunchOption}).then(function(r){e.init(Object.assign(r,e.config.commonData,t))}).catch(function(t){y.log("初始化失败"),console.log(t)})},n.prototype.detectChanel=function(t){if(t){var e={};t.split(/_+/).forEach(function(t,r){e["source_src_key_"+(r+1)]=t}),this.evt("channel",e)}},n.prototype.composeCommonData=function(t){var e=[];return t.map(function(t){"function"==typeof t?e.push(new Promise(function(e){t(e)})):e.push(Promise.resolve(t))}),e.push(Promise.resolve(this.injectTimestamp({}))),Promise.all(e).then(function(t){return Promise.resolve(Object.assign.apply(Object,[{}].concat(t)))})},n.prototype.track=function(){for(var t=this,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.composeCommonData(e).then(function(e){return t.log(e)})},n.prototype.forceTrack=function(){for(var t=this,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.composeCommonData(e).then(function(e){return t.forceLog(e)})},n.prototype.evt=function(t){void 0===t&&(t="");for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(!t)throw new Error("缺少 action 参数");this.track.apply(this,e.concat([{action:t,tracktype:"event"}]))},n.prototype.forceEvt=function(t){void 0===t&&(t="");for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(!t)throw new Error("缺少 action 参数");this.forceTrack.apply(this,e.concat([{action:t,tracktype:"event"}]))},n.prototype.pv=function(t){var e=this;void 0===t&&(t="");for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];this.composeCommonData(r).then(function(r){e.log(Object.assign(r,e.genLastPageUrl(r),{action:t,tracktype:"pageview"}))})},n.prototype.genLastPageUrl=function(t){var e=this,r=e.last_page_id,n=void 0===r?"":r,o=e.last_page_url,i=void 0===o?"":o;return this.last_page_url=t.page_url||"",this.last_page_id=t.page_id||"",{last_page_id:n,last_page_url:i}},r([p()],n.prototype,"asyncInitWithCommonData",null),r([p()],n.prototype,"detectChanel",null),r([p()],n.prototype,"composeCommonData",null),r([p()],n.prototype,"track",null),r([p()],n.prototype,"forceTrack",null),r([p()],n.prototype,"evt",null),r([p()],n.prototype,"forceEvt",null),r([p()],n.prototype,"pv",null),r([p()],n.prototype,"genLastPageUrl",null),n}($),X=J.generateTrackerInstance({});t.Tracker=$,t.BxTracker=J,t.tracker=X,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=anka-tracker.min.js.map
